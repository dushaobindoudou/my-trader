### 项目实施指南

本文档包含技术选型、数据模型、实施路线图等实现细节，与需求文档分离。

---

### 1. 数据模型设计（简化版）

为了保持简单，系统只需要5个核心数据表：

#### 1.1 信息条目表 (knowledge_entries)
| 字段名 | 类型 (PostgreSQL) | 说明 | 必填 |
|--------|-------------------|------|------|
| id | UUID (主键) | 唯一标识 | ✓ |
| content | TEXT | 信息内容（无长度限制） | ✓ |
| category | VARCHAR(50) | 主分类（机构成本/市场新闻/研报观点/宏观数据/个人见解） | ✓ |
| tags | TEXT[] | 标签数组（PostgreSQL原生数组类型） | - |
| created_at | TIMESTAMPTZ | 创建时间（带时区） | ✓ |
| updated_at | TIMESTAMPTZ | 最后修改时间（带时区） | ✓ |

**索引：** `category`, `tags`（使用GIN索引），`created_at`

#### 1.2 LLM配置表 (llm_configs)
| 字段名 | 类型 (PostgreSQL) | 说明 | 必填 |
|--------|-------------------|------|------|
| id | UUID (主键) | 唯一标识 | ✓ |
| name | VARCHAR(100) | 模型名称（如"GPT-4"） | ✓ |
| api_key | VARCHAR(255) | API密钥（加密存储） | ✓ |
| api_url | VARCHAR(255) | API端点 | ✓ |
| is_active | BOOLEAN | 是否启用 | ✓ |
| created_at | TIMESTAMPTZ | 创建时间 | ✓ |

**注意：** API密钥建议使用 Vercel 环境变量存储，不直接存数据库

#### 1.3 Agent配置表 (agent_configs)
| 字段名 | 类型 (PostgreSQL) | 说明 | 必填 |
|--------|-------------------|------|------|
| id | UUID (主键) | 唯一标识 | ✓ |
| name | VARCHAR(100) | Agent名称（如"趋势分析师"） | ✓ |
| description | TEXT | Agent描述 | - |
| system_prompt | TEXT | 系统提示词 | ✓ |
| is_default | BOOLEAN | 是否为默认Agent | ✓ |
| is_active | BOOLEAN | 是否启用 | ✓ |
| created_at | TIMESTAMPTZ | 创建时间 | ✓ |
| updated_at | TIMESTAMPTZ | 更新时间 | ✓ |

**索引：** `is_default`, `is_active`, `created_at`

#### 1.4 分析历史表 (analysis_history)
| 字段名 | 类型 (PostgreSQL) | 说明 | 必填 |
|--------|-------------------|------|------|
| id | UUID (主键) | 唯一标识 | ✓ |
| question | TEXT | 用户提问 | ✓ |
| context_ids | UUID[] | 使用的信息条目ID列表（数组） | ✓ |
| agent_config_id | UUID | 使用的Agent配置ID | ✓ |
| responses | JSONB | 各模型的回答（JSON对象） | ✓ |
| created_at | TIMESTAMPTZ | 创建时间 | ✓ |

**索引：** `created_at`，`context_ids`（使用GIN索引），`agent_config_id`

#### 1.5 投资决策表 (trade_records)
| 字段名 | 类型 (PostgreSQL) | 说明 | 必填 |
|--------|-------------------|------|------|
| id | UUID (主键) | 唯一标识 | ✓ |
| asset | VARCHAR(50) | 标的名称（如"BTC", "AAPL"） | ✓ |
| action | VARCHAR(20) | 操作类型（买入/卖出/加仓/减仓） | ✓ |
| amount | DECIMAL(15,2) | 投资金额 | ✓ |
| price | DECIMAL(15,4) | 买入/卖出价格 | - |
| quantity | DECIMAL(15,6) | 数量 | - |
| reason | TEXT | 买入/卖出原因 | ✓ |
| tags | TEXT[] | 标签数组 | - |
| created_at | TIMESTAMPTZ | 交易时间 | ✓ |
| note | TEXT | 备注 | - |

**索引：** `asset`, `created_at`

#### 1.6 观察标的表 (watchlist)
| 字段名 | 类型 (PostgreSQL) | 说明 | 必填 |
|--------|-------------------|------|------|
| id | UUID (主键) | 唯一标识 | ✓ |
| asset | VARCHAR(50) | 标的名称 | ✓ |
| reason | TEXT | 观察原因 | ✓ |
| target_price | DECIMAL(15,4) | 目标价格 | - |
| current_price | DECIMAL(15,4) | 当前价格（手动更新） | - |
| status | VARCHAR(20) | 状态（观察中/已买入/已放弃） | ✓ |
| tags | TEXT[] | 标签数组 | - |
| created_at | TIMESTAMPTZ | 加入时间 | ✓ |
| updated_at | TIMESTAMPTZ | 更新时间 | ✓ |
| note | TEXT | 备注 | - |

**索引：** `asset`, `status`, `created_at`

#### 1.7 资产组合表 (asset_portfolio)
| 字段名 | 类型 (PostgreSQL) | 说明 | 必填 |
|--------|-------------------|------|------|
| id | UUID (主键) | 唯一标识 | ✓ |
| asset | VARCHAR(50) | 资产名称（BTC、ETH、USDT等） | ✓ |
| asset_type | VARCHAR(20) | 资产类型（crypto/stock/precious_metal/cash） | ✓ |
| quantity | DECIMAL(20,8) | 持仓数量 | ✓ |
| avg_cost_price | DECIMAL(15,4) | 平均成本价格 | ✓ |
| current_price | DECIMAL(15,4) | 当前价格（手动更新） | - |
| total_cost | DECIMAL(15,2) | 总成本（数量 × 平均成本） | ✓ |
| current_value | DECIMAL(15,2) | 当前价值（数量 × 当前价格） | - |
| unrealized_pnl | DECIMAL(15,2) | 未实现盈亏 | - |
| realized_pnl | DECIMAL(15,2) | 已实现盈亏 | - |
| created_at | TIMESTAMPTZ | 创建时间 | ✓ |
| updated_at | TIMESTAMPTZ | 更新时间 | ✓ |

**索引：** `asset`, `asset_type`, `updated_at`

#### 1.8 现金记录表 (cash_transactions)
| 字段名 | 类型 (PostgreSQL) | 说明 | 必填 |
|--------|-------------------|------|------|
| id | UUID (主键) | 唯一标识 | ✓ |
| currency | VARCHAR(10) | 货币类型（USDT、USDC、USD等） | ✓ |
| transaction_type | VARCHAR(20) | 交易类型（inflow/outflow） | ✓ |
| amount | DECIMAL(15,2) | 金额 | ✓ |
| balance_after | DECIMAL(15,2) | 交易后余额 | ✓ |
| description | TEXT | 描述（充值、提现、收入等） | - |
| created_at | TIMESTAMPTZ | 交易时间 | ✓ |

**索引：** `currency`, `transaction_type`, `created_at`

**说明：** 
- 使用 UUID 作为主键（Supabase 默认推荐）
- 使用 PostgreSQL 原生数组类型存储标签，支持高效查询
- 时间戳使用 TIMESTAMPTZ 带时区类型
- 使用 JSONB 存储复杂对象（如分析结果），支持高效查询
- 资产组合表支持多币种持仓管理
- 现金记录表支持多币种现金流水管理
- Agent配置表支持预设不同的系统提示词，实现不同的分析角色

---

### 2. 技术选型建议（以简单为原则）

#### 2.1 推荐方案：Vercel部署 + Supabase数据库

**前端框架：**
- **框架：** Next.js 14+ (App Router)（Vercel原生支持，性能最优）
- **UI组件：** shadcn/ui + Tailwind CSS（轻量、现代、免费）
- **状态管理：** React Server Components + Zustand（按需使用）

**后端方案：**
- **API层：** Next.js API Routes / Server Actions（无需单独后端）
- **数据库：** Supabase（免费版提供500MB存储 + PostgreSQL）
- **ORM：** Prisma（类型安全、开发体验好）或 Supabase Client SDK

**LLM集成：**
- 使用 OpenAI SDK 或 Vercel AI SDK（支持多模型）
- 收费模型：OpenAI GPT-4、Claude、Gemini等
- API调用在服务端进行，保护API密钥

**部署方式：**
- **前端 + API：** Vercel（免费版包含100GB带宽/月 + 无限请求）
- **数据库：** Supabase（免费版 500MB 存储 + 50MB 文件存储）
- **域名：** Vercel提供免费子域名（可绑定自定义域名）

#### 2.2 为什么选择这个技术栈？

1. **Next.js + Vercel：** 零配置部署，自动HTTPS，全球CDN加速
2. **Supabase：** 免费PostgreSQL数据库，实时订阅，内置认证（可选）
3. **shadcn/ui + Tailwind：** 现代化UI组件，完全免费，可定制性强
4. **Prisma：** 类型安全，自动生成数据库客户端，迁移管理简单
5. **成本优势：** 个人使用完全免费，仅LLM调用产生费用
6. **开发效率：** 全栈TypeScript，端到端类型安全，开发体验极佳

#### 2.3 成本估算（基于个人使用）

| 服务 | 免费额度 | 收费情况 | 预估成本/月 |
|------|---------|---------|------------|
| Vercel | 100GB 带宽、无限请求 | 超出付费 | $0（个人使用足够） |
| Supabase | 500MB 数据库、50,000 请求/月 | 超出付费 | $0（个人使用足够） |
| OpenAI GPT-4 | 无免费额度 | $0.01/1K tokens (输入) | $5-20/月（取决于使用频率） |
| Anthropic Claude | 无免费额度 | $0.008/1K tokens (输入) | $5-20/月（取决于使用频率） |
| 域名（可选） | - | $10-15/年 | $1-2/月 |

**总计：** 月均成本 $10-40（主要是 LLM 调用费用）

**优化建议：**
- 使用 prompt 缓存减少 token 消耗
- 使用 GPT-3.5 作为低成本备选
- 批量处理分析请求，减少重复调用

#### 2.4 技术栈对比（为什么不用其他方案）

| 方案 | 优势 | 劣势 | 是否采用 |
|------|------|------|---------|
| **Next.js + Vercel + Supabase** | 零配置、全栈 TypeScript、免费部署 | 需要学习 React | ✅ **推荐** |
| FastAPI + Vue + SQLite | 熟悉的技术栈、本地部署 | 需要服务器、无法云端访问 | ❌ |
| Django + PostgreSQL | 功能完整、admin 自带 | 过于重量级、部署复杂 | ❌ |
| Firebase + React | 实时数据库、简单易用 | 成本较高、锁定供应商 | ❌ |
| Electron 桌面应用 | 离线可用、隐私性强 | 无法多设备同步 | ❌ |

---

### 3. MVP实施路线图（最小可行产品）

将项目分为4个阶段，每个阶段都是可用的：

#### 第一阶段：环境搭建 + 核心知识库（预计2-3天）
**目标：** 搭建开发环境，能够录入、查看、编辑、删除信息

**环境准备：**
- [ ] 创建 Next.js 项目（`npx create-next-app@latest`）
- [ ] 安装并配置 Tailwind CSS 和 shadcn/ui
- [ ] 创建 Supabase 项目，获取数据库连接信息
- [ ] 安装 Prisma，配置数据库连接
- [ ] 创建 5 个数据表的 Prisma Schema
- [ ] 运行数据库迁移
- [ ] 配置环境变量（`.env.local`）

**核心功能：**
- [ ] 实现信息录入界面（主分类 + 标签 + 内容）
- [ ] 实现信息列表展示（使用 Server Components）
- [ ] 实现信息编辑和删除（Server Actions）
- [ ] 实现基础过滤（按分类、按标签）
- [ ] 实现时间排序
- [ ] 部署到 Vercel（连接 GitHub 仓库）

**完成标准：** 能够在线上环境录入至少50条真实信息，并能快速筛选查看。

#### 第二阶段：投资决策与资产管理（预计3天）
**目标：** 记录交易决策，管理资产组合

**功能清单：**
- [ ] 实现投资决策录入界面
- [ ] 实现交易记录列表（按时间、标的筛选）
- [ ] 实现资产组合管理（持仓统计、盈亏计算）
- [ ] 实现现金管理（多币种现金流水）
- [ ] 实现观察标的管理（增删改查）
- [ ] 实现观察标的状态更新
- [ ] 统计功能（总投入、单个标的盈亏、资产配置）

**完成标准：** 能够记录完整的交易流程（从观察到买入到卖出），并能查看资产组合总览。

#### 第三阶段：搜索与导出（预计1-2天）
**目标：** 增强信息管理能力

**功能清单：**
- [ ] 实现全文搜索功能（PostgreSQL 全文搜索）
- [ ] 实现时间范围筛选（日期选择器）
- [ ] 实现组合过滤（分类+标签+时间+搜索关键词）
- [ ] 实现数据导出（JSON格式，使用 Server Actions）
- [ ] 优化列表显示（虚拟滚动、摘要显示、标签云）
- [ ] 添加 loading 状态和骨架屏

**完成标准：** 能够在100+条信息中快速定位到想要的内容，体验流畅。

#### 第四阶段：LLM分析（预计2-3天）
**目标：** 接入LLM，实现多模型对比分析

**功能清单：**
- [ ] 配置 LLM API（在 Vercel 环境变量中设置）
- [ ] 安装 Vercel AI SDK 或 OpenAI SDK
- [ ] 实现 LLM 配置管理界面（支持多个模型）
- [ ] 实现 Agent 配置管理界面（预设 + 自定义）
- [ ] 实现上下文选择功能（勾选信息条目）
- [ ] 实现 Agent 选择功能（下拉选择或卡片选择）
- [ ] 实现分析 API Route（使用 Next.js Route Handler）
- [ ] 实现多模型并行调用（Promise.all）
- [ ] 实现流式响应展示（可选，使用 streaming）
- [ ] 实现结果对比展示（左右布局或卡片布局）
- [ ] 实现分析历史记录存储（包含 Agent 配置信息）
- [ ] 实现历史记录查看和搜索

**完成标准：** 能够选择10-20条信息作为上下文，选择不同的Agent配置，同时向2-3个LLM提问并对比结果。

#### 4.1 Agent配置示例（从简单到复杂）

**基础Agent配置：**

1. **趋势分析师**（最简单）
   - 名称：趋势分析师
   - 描述：专注于市场趋势和价格走势分析
   - 系统提示词：
     ```
     你是一位专业的趋势分析师，擅长分析市场趋势和价格走势。
     请基于提供的信息，重点关注：
     1. 价格趋势方向（上涨/下跌/横盘）
     2. 关键支撑位和阻力位
     3. 技术指标信号
     4. 趋势持续时间预期
     
     请用简洁明了的语言回答，避免过于复杂的技术术语。
     ```

2. **风险控制师**
   - 名称：风险控制师
   - 描述：专注于风险评估和资金管理建议
   - 系统提示词：
     ```
     你是一位专业的风险控制师，擅长评估投资风险和提供资金管理建议。
     请基于提供的信息，重点关注：
     1. 潜在风险点识别
     2. 风险等级评估（高/中/低）
     3. 资金管理建议
     4. 止损和止盈建议
     
     请提供实用的风险管理建议，帮助投资者控制风险。
     ```

3. **数据研究员**
   - 名称：数据研究员
   - 描述：专注于数据解读和量化分析
   - 系统提示词：
     ```
     你是一位专业的数据研究员，擅长解读数据和进行量化分析。
     请基于提供的信息，重点关注：
     1. 关键数据指标解读
     2. 数据变化趋势分析
     3. 数据与价格的相关性
     4. 量化分析结论
     
     请用数据说话，提供客观的分析结论。
     ```

4. **宏观分析师**
   - 名称：宏观分析师
   - 描述：专注于宏观经济和政策影响分析
   - 系统提示词：
     ```
     你是一位专业的宏观分析师，擅长分析宏观经济和政策对市场的影响。
     请基于提供的信息，重点关注：
     1. 宏观经济环境分析
     2. 政策影响评估
     3. 市场情绪分析
     4. 长期趋势判断
     
     请从宏观角度提供投资建议和趋势判断。
     ```

**高级Agent配置（可选）：**

5. **机构成本分析师**
   - 名称：机构成本分析师
   - 描述：专门分析机构持仓成本，提供成本区间参考
   - 系统提示词：
     ```
     你是一位专业的机构成本分析师，专门分析大机构的持仓成本。
     请基于提供的信息，重点关注：
     1. 机构持仓成本区间
     2. 成本分布情况
     3. 机构行为模式
     4. 成本支撑/阻力作用
     
     请提供机构成本相关的专业分析，帮助判断市场底部和顶部。
     ```

**实施建议：**
- 第一阶段：先实现前2个基础Agent（趋势分析师、风险控制师）
- 第二阶段：添加数据研究员和宏观分析师
- 第三阶段：根据用户反馈添加更多专业Agent
- 所有Agent配置支持用户自定义修改系统提示词

#### 总耗时估计：8-11天（兼职开发）

---

### 4. 界面设计建议（保持极简）

#### 4.1 主界面布局
```
┌─────────────────────────────────────────────────────────────┐
│  [知识库] [投资记录] [资产管理] [观察列表] [LLM分析] [历史] [设置] │  ← 顶部导航
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  左侧：筛选面板    中间：Agent选择    右侧：内容区域           │
│  - 主分类 (单选)   - Agent卡片选择    - 信息列表              │
│  - 标签 (多选)     - 快速切换        - 或投资记录             │
│  - 时间范围        - 预览提示词      - 或资产组合             │
│  - 搜索框          - 自定义编辑      - 或观察列表             │
│                   - 默认标记        - 或分析界面             │
│                                     - 或历史记录             │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

#### 4.2 核心页面
1. **知识库页面：** 左侧筛选 + 右侧列表 + 顶部"新建信息"按钮
2. **投资记录页面：** 时间线展示 + 统计面板（总投入、收益率）
3. **资产管理页面：** 资产组合总览 + 持仓详情 + 现金管理
4. **观察列表页面：** 卡片式展示 + 状态标签 + 快速操作按钮
5. **分析页面：** 左侧筛选（勾选信息）+ 中间Agent选择 + 右侧提问框和结果对比区
   - 左侧：信息筛选和勾选（支持多选）
   - 中间：Agent选择区域
     - Agent卡片展示（名称、描述、默认标记）
     - 点击切换Agent，实时预览系统提示词
     - 支持快速编辑Agent配置
   - 右侧：提问框 + 多模型结果对比区
     - 顶部：问题输入框
     - 下方：并排显示各模型回答
6. **历史记录页面：** 时间线展示，点击展开详情
7. **设置页面：** LLM模型管理 + Agent配置管理
   - LLM模型管理（增删改查）
   - Agent配置管理（增删改查）
     - 预设Agent：趋势分析师、风险控制师、数据研究员等
     - 自定义Agent：用户可创建专属的分析角色
     - 系统提示词编辑：支持富文本编辑，实时预览

#### 4.3 交互原则
- **一键录入：** 点击"新建"，弹出表单，填写后点击"保存"，共2次点击
- **快速筛选：** 点击分类/标签即可筛选，无需点击"确认"按钮
- **直观对比：** 分析结果左右并排，一眼看出差异
- **快速操作：** 观察列表可一键转为买入记录
- **Agent切换：** 点击Agent卡片即可切换，无需确认，实时生效
- **智能默认：** 系统记住用户常用的Agent配置，自动设置为默认

---

### 5. MVP验收标准

在项目完成后，您应该能够：

1. ✅ **5分钟内录入一条完整的机构成本信息**（包括选分类、打标签）
2. ✅ **10秒内找到所有关于某个资产（如BTC）的机构成本记录**
3. ✅ **1分钟内记录一笔交易**（标的、金额、原因）
4. ✅ **快速查看资产组合总览**（总价值、持仓比例、盈亏情况）
5. ✅ **快速查看观察列表中所有标的的状态**
6. ✅ **30秒内选择10-20条信息作为上下文，选择Agent配置，向3个LLM提问**
7. ✅ **在一个屏幕内对比3个LLM的回答，无需滚动页面**
8. ✅ **快速切换不同的Agent配置，体验不同的分析风格**
9. ✅ **导出所有数据为JSON文件，用于备份**

如果以上9点都能轻松做到，说明MVP已经达到可用标准。

---

### 6. 下一步行动建议

#### 6.1 环境准备（第一天）

1. **安装必要工具：**
   - Node.js 18+ 
   - pnpm 或 npm（推荐使用 pnpm）
   - Git
   - VS Code（推荐安装 Tailwind CSS IntelliSense、Prisma 插件）

2. **注册必要服务：**
   - GitHub 账号（用于代码托管和 Vercel 部署）
   - Vercel 账号（使用 GitHub 登录）
   - Supabase 账号（免费版）
   - OpenAI/Anthropic 账号（LLM API，第四阶段使用）

3. **创建项目：**
   ```bash
   npx create-next-app@latest ai-trader
   # 选择：TypeScript, Tailwind CSS, App Router, ESLint
   cd ai-trader
   npx shadcn-ui@latest init
   ```

4. **配置 Supabase：**
   - 在 Supabase 创建新项目
   - 复制数据库连接字符串
   - 配置 `.env.local`：
     ```
     DATABASE_URL="postgresql://..."
     DIRECT_URL="postgresql://..."
     ```

5. **配置 Prisma：**
   ```bash
   pnpm add prisma @prisma/client
   npx prisma init
   # 编辑 prisma/schema.prisma，定义5个数据表
   npx prisma db push
   npx prisma generate
   ```

#### 6.2 开发流程（第二天起）

1. **第一阶段：** 专注于知识库模块，先把信息录入和管理做扎实
2. **第二阶段：** 添加投资记录和观察列表功能
3. **第三阶段：** 实现搜索和导出功能
4. **第四阶段：** 接入 LLM 分析
5. **真实使用：** 每个阶段完成后立即录入真实数据，边用边调整
6. **持续部署：** 每次提交代码后，Vercel 自动部署

#### 6.3 部署流程

1. **初次部署：**
   - 将代码推送到 GitHub
   - 在 Vercel 导入 GitHub 仓库
   - 配置环境变量（DATABASE_URL, DIRECT_URL）
   - Vercel 自动构建和部署

2. **后续更新：**
   - 提交代码到 GitHub
   - Vercel 自动触发部署
   - 预览环境自动生成（每个 PR）

**关键原则：先做出来，再做好；边用边改，快速迭代。每个阶段完成后立即部署上线。**

