# 知识库模块开发任务清单

## 模块概述
知识库模块是系统的核心模块，用于管理个人收集的投资信息和市场数据。这些信息经过筛选，对交易决策极其有用。知识库模块支持信息录入、分类、标签管理、主题分组、检索、搜索、编辑、删除和数据导出等功能。**主题功能**允许用户对信息进行分组管理（如：BTC、英伟达等主题），方便查看和管理，并可快速添加到LLM分析上下文中。

## 功能子模块划分

### 子模块一：信息录入
- 普通文本录入
- 机构成本专用录入（简化方式 + 结构化方式）
- 分类选择（5个预设主分类）
- 标签管理（支持多标签、自由创建）
- **置信度评分**（1-10分制，可选，用于评估信息可靠程度）

### 子模块二：信息展示
- 列表展示（主分类、标签、摘要、时间、置信度评分）
- 详情展示
- 卡片式/列表式切换
- **置信度显示**（星级、进度条或数字等形式）

### 子模块三：信息筛选
- 按主分类筛选
- 按标签筛选（支持多选）
- 按时间范围筛选
- **按置信度范围筛选**（高置信度/中置信度/低置信度）
- 组合筛选（分类+标签+时间+置信度）
- 排序功能（时间正序/倒序、**置信度排序**）

### 子模块四：信息搜索
- 关键词搜索（全文匹配）
- 搜索 + 筛选组合
- 高亮显示搜索关键词

### 子模块五：信息管理
- 编辑功能
- 删除功能（二次确认）
- 批量操作（可选）

### 子模块六：数据导出
- JSON格式导出
- CSV格式导出
- 筛选后导出
- 全量导出

### 子模块七：主题管理（新增）
- **主题创建与管理**（创建、编辑、删除、重命名）
- **信息与主题关联**（录入时选择、编辑时修改、批量添加到主题）
- **按主题筛选查看**（主题视图、主题列表）
- **从标签创建主题**（基于标签自动生成主题建议）
- **快速添加到分析上下文**（在分析页面选择主题，快速加载该主题下的所有信息）

---

## 阶段一：基础数据结构与API（核心基础）

### 1.1 数据库 Schema 验证
- [ ] 确认 knowledge_entries 表结构（id, content, category, tags, created_at, updated_at）
- [ ] 验证置信度评分字段（confidence_score）是否存在
  - 字段类型：INTEGER（1-10分制）
  - 约束：NULL 或 1-10 之间
  - 索引：按置信度筛选和排序的索引
- [ ] 验证索引是否完整（category, tags GIN索引, created_at, confidence_score）
- [ ] 验证 updated_at 触发器是否正常工作

**状态**: ⏳ 待开始  
**预计时间**: 0.5天

### 1.1.1 应用置信度评分数据库迁移
- [ ] 执行数据库迁移 `20240102000000_add_confidence_score.sql`
- [ ] 验证 confidence_score 字段已成功添加
- [ ] 验证约束和索引正常工作

**状态**: ⏳ 待开始  
**预计时间**: 0.5天  
**依赖**: 1.1

### 1.1.2 应用主题功能数据库迁移
- [ ] 执行数据库迁移 `20240103000000_add_topics.sql`
- [ ] 验证 topics 表结构（id, name, description, color, icon, created_at, updated_at）
- [ ] 验证 knowledge_entry_topics 关联表结构
- [ ] 验证索引是否完整（topics.name, topics.created_at, 关联表索引）
- [ ] 验证唯一约束（topics.name 唯一，entry-topic 组合唯一）
- [ ] 验证外键约束和级联删除正常工作
- [ ] 验证 updated_at 触发器正常工作

**状态**: ⏳ 待开始  
**预计时间**: 0.5天  
**依赖**: 1.1

### 1.2 创建 API 路由
- [ ] 创建 `src/app/api/knowledge/route.ts` (GET, POST)
  - GET: 获取知识库条目列表（支持分页、筛选、排序、主题筛选）
  - POST: 创建新的知识库条目（支持关联主题）
- [ ] 创建 `src/app/api/knowledge/[id]/route.ts` (GET, PATCH, DELETE)
  - GET: 获取单个条目详情（包含主题信息）
  - PATCH: 更新条目（支持更新主题关联）
  - DELETE: 删除条目
- [ ] 创建 `src/app/api/knowledge/export/route.ts` (GET)
  - GET: 导出数据（支持 JSON/CSV 格式，支持筛选条件）
- [ ] 创建 `src/app/api/topics/route.ts` (GET, POST)
  - GET: 获取所有主题列表（包含条目数量）
  - POST: 创建新主题
- [ ] 创建 `src/app/api/topics/[id]/route.ts` (GET, PATCH, DELETE)
  - GET: 获取单个主题详情（包含条目列表）
  - PATCH: 更新主题
  - DELETE: 删除主题（级联删除关联）
- [ ] 创建 `src/app/api/topics/[id]/entries/route.ts` (GET, POST, DELETE)
  - GET: 获取主题下的所有条目
  - POST: 批量添加条目到主题
  - DELETE: 从主题中移除条目

**状态**: ⏳ 待开始  
**预计时间**: 2天  
**依赖**: 1.1

### 1.3 创建类型定义
- [ ] 创建 `src/types/knowledge.ts`
  - KnowledgeEntry 接口（包含 confidence_score: number | null, topic_ids: string[]）
  - Category 枚举（机构成本、市场新闻、研报观点、宏观数据、个人见解）
  - ConfidenceLevel 枚举或类型（高/中/低，用于筛选）
  - KnowledgeEntryCreateInput（包含 confidence_score, topic_ids）
  - KnowledgeEntryUpdateInput（包含 confidence_score, topic_ids）
  - KnowledgeEntryFilter（分类、标签、时间范围、关键词、置信度范围、主题ID）
  - KnowledgeEntrySort（排序字段和方向，包含置信度排序）
- [ ] 创建 `src/types/topic.ts`
  - Topic 接口（id, name, description, color, icon, created_at, updated_at）
  - TopicCreateInput
  - TopicUpdateInput
  - TopicWithEntryCount（包含条目数量）

**状态**: ⏳ 待开始  
**预计时间**: 1天

### 1.4 创建 Supabase 客户端工具函数
- [ ] 在 `src/lib/supabase/` 中创建或更新客户端
- [ ] 创建 `src/lib/knowledge.ts`
  - 封装所有知识库相关的数据库操作函数
  - `getKnowledgeEntries()` - 查询列表（支持主题筛选）
  - `getKnowledgeEntryById()` - 查询单个（包含主题信息）
  - `createKnowledgeEntry()` - 创建（支持关联主题）
  - `updateKnowledgeEntry()` - 更新（支持更新主题关联）
  - `deleteKnowledgeEntry()` - 删除
  - `exportKnowledgeEntries()` - 导出
- [ ] 创建 `src/lib/topics.ts`
  - `getTopics()` - 获取所有主题（包含条目数量）
  - `getTopicById()` - 获取单个主题详情
  - `createTopic()` - 创建主题
  - `updateTopic()` - 更新主题
  - `deleteTopic()` - 删除主题（级联删除关联）
  - `getTopicEntries()` - 获取主题下的所有条目
  - `addEntriesToTopic()` - 批量添加条目到主题
  - `removeEntryFromTopic()` - 从主题中移除条目
  - `getTopicsFromLabels()` - 基于标签生成主题建议（可选）

**状态**: ⏳ 待开始  
**预计时间**: 2天  
**依赖**: 1.1, 1.3

---

## 阶段二：信息录入功能（核心功能）

### 2.1 创建信息录入对话框组件
- [ ] 创建 `src/components/knowledge/entry-form.tsx`
  - 使用 shadcn/ui Dialog 组件
  - 表单字段：
    - 内容（Textarea，支持多行）
    - 主分类（Select，5个预设分类）
    - 标签（Multi-select 或 Tag Input）
    - **置信度评分**（Slider 或 Select，1-10分，可选）
      - 显示评分说明（1=不可靠，10=非常可靠）
      - 提供快速选择按钮（高/中/低）
    - **主题选择**（Multi-select，支持多选）
      - 显示已有主题列表（带颜色标识）
      - 支持创建新主题（快速创建）
      - 显示每个主题的条目数量
    - 提交/取消按钮
  - 表单验证（必填字段、内容长度限制）

**状态**: ⏳ 待开始  
**预计时间**: 2天  
**依赖**: 1.3

### 2.2 实现机构成本专用录入模式
- [ ] 在 `entry-form.tsx` 中添加机构成本检测逻辑
  - 当选择"机构成本"分类时，切换录入模式
- [ ] 实现简化方式（文本格式录入）
  - 提示格式："资产: BTC, 机构: 贝莱德, 成本价: 约 $60,000, 来源: 链上数据分析, 备注: ..."
  - 提供格式示例
- [ ] 实现结构化方式（可选）
  - 显示专用字段：资产/标的、机构名称、成本价格/区间
  - 主文本框用于填写来源/备注
  - 添加切换按钮（简化方式 ↔ 结构化方式）

**状态**: ⏳ 待开始  
**预计时间**: 1.5天  
**依赖**: 2.1

### 2.3 实现标签管理
- [ ] 创建 `src/components/knowledge/tag-input.tsx`
  - 支持自由输入创建标签
  - 支持从已有标签列表中选择
  - 显示已选择的标签（可删除）
  - 标签建议/自动完成（可选）
- [ ] 标签数据管理
  - 从所有条目中提取已有标签列表
  - 标签去重和统计（可选：显示使用次数）

**状态**: ⏳ 待开始  
**预计时间**: 1.5天  
**依赖**: 2.1

### 2.4 实现表单提交逻辑
- [ ] 在 `entry-form.tsx` 中使用 Server Actions
  - 创建 `src/app/knowledge/actions.ts`
  - 实现 `createKnowledgeEntry()` Server Action
  - 表单验证和数据清理
  - 错误处理和成功提示
  - 提交后关闭对话框并刷新列表

**状态**: ⏳ 待开始  
**预计时间**: 1天  
**依赖**: 2.1, 1.4

### 2.5 集成到知识库页面
- [ ] 在 `src/app/knowledge/page.tsx` 中集成录入对话框
  - "新建信息"按钮触发对话框
  - 处理表单提交成功后的列表刷新

**状态**: ⏳ 待开始  
**预计时间**: 0.5天  
**依赖**: 2.1, 2.4

---

## 阶段三：信息展示功能（核心功能）

### 3.1 创建信息列表组件
- [ ] 创建 `src/components/knowledge/entry-list.tsx`
  - 使用 Server Components 获取数据
  - 卡片式布局显示条目
  - 显示字段：主分类、标签（前3个）、内容摘要（前100字）、创建时间
  - 点击卡片跳转到详情或展开详情（可选）

**状态**: ⏳ 待开始  
**预计时间**: 1天  
**依赖**: 1.4

### 3.2 创建信息卡片组件
- [ ] 创建 `src/components/knowledge/entry-card.tsx`
  - 使用 shadcn/ui Card 组件
  - 显示分类标签（带颜色区分）
  - 显示标签列表（Badge 组件）
  - **显示主题标签**（Badge 组件，带颜色和图标）
    - 显示条目所属的主题（前2-3个）
    - 点击主题标签可筛选该主题
  - **显示置信度评分**（星级、进度条或数字形式）
    - 未评分显示"未评分"或隐藏
    - 已评分显示可视化的评分（如：⭐⭐⭐⭐⭐ 5/10）
    - 使用颜色区分（高：绿色，中：黄色，低：红色）
  - 显示内容摘要（截断显示，支持展开）
  - 显示时间（格式化，相对时间）
  - 操作按钮（编辑、删除）- 可选悬浮显示

**状态**: ⏳ 待开始  
**预计时间**: 2天  
**依赖**: 3.1

### 3.3 实现详情展示
- [ ] 创建 `src/components/knowledge/entry-detail.tsx`
  - 显示完整内容
  - 显示所有标签
  - **显示置信度评分**（详细展示，包含评分说明）
  - 显示创建时间和修改时间
  - 编辑按钮（跳转到编辑对话框）
  - 删除按钮

**状态**: ⏳ 待开始  
**预计时间**: 0.5天  
**依赖**: 3.1

### 3.4 实现列表/卡片视图切换（可选）
- [ ] 添加视图切换按钮
  - 列表视图（紧凑）
  - 卡片视图（详细）
  - 使用本地存储记住用户偏好

**状态**: ⏳ 待开始  
**预计时间**: 0.5天  
**依赖**: 3.1

### 3.5 实现分页功能
- [ ] 在 `entry-list.tsx` 中添加分页
  - 使用 shadcn/ui Pagination 组件
  - 每页显示数量选择（10/20/50）
  - 分页信息显示（共X条，第X页）

**状态**: ⏳ 待开始  
**预计时间**: 0.5天  
**依赖**: 3.1, 1.4

### 3.6 集成到知识库页面
- [ ] 在 `src/app/knowledge/page.tsx` 中集成列表组件
  - 替换占位内容
  - 处理加载状态（Skeleton）
  - 处理空状态（无数据提示）

**状态**: ⏳ 待开始  
**预计时间**: 0.5天  
**依赖**: 3.1, 3.5

---

## 阶段四：信息筛选功能（核心功能）

### 4.1 创建筛选面板组件
- [ ] 创建 `src/components/knowledge/filter-panel.tsx`
  - 使用 shadcn/ui 组件（Select, Checkbox, DatePicker）
  - 布局：左侧固定面板或顶部折叠面板
  - 筛选条件：
    - 主分类筛选（单选，包含"全部"选项）
    - 标签筛选（多选，支持搜索已有标签）
    - **主题筛选**（多选，支持搜索已有主题）
      - 显示主题列表（带颜色和图标）
      - 显示每个主题的条目数量
      - 点击主题标签快速筛选
    - 时间范围筛选（最近7天、最近30天、自定义日期范围）
    - **置信度范围筛选**（单选或多选）
      - 选项：全部、高置信度（7-10）、中置信度（4-6）、低置信度（1-3）、未评分
      - 或使用范围滑块（最小值-最大值）
  - 重置按钮

**状态**: ⏳ 待开始  
**预计时间**: 2.5天  
**依赖**: 1.3

### 4.2 实现筛选逻辑
- [ ] 在 API 路由中实现筛选查询
  - 更新 `src/app/api/knowledge/route.ts` 的 GET 方法
  - 支持 query 参数：
    - `category` - 主分类筛选
    - `tags` - 标签筛选（逗号分隔）
    - `topics` - 主题筛选（逗号分隔的UUID）
    - `topicIds` - 主题ID筛选（别名，支持单个或多个）
    - `startDate` / `endDate` - 时间范围
    - `search` - 关键词搜索
    - `confidenceMin` / `confidenceMax` - 置信度范围筛选
    - `confidenceLevel` - 置信度等级筛选（high/medium/low/unrated）
    - `sort` - 排序字段和方向
    - `page` / `limit` - 分页参数
  - 使用 Supabase 查询构建器实现筛选
  - 实现置信度范围筛选逻辑
  - 实现主题筛选逻辑（JOIN 关联表）

**状态**: ⏳ 待开始  
**预计时间**: 2.5天  
**依赖**: 4.1, 1.4

### 4.3 实现排序功能
- [ ] 在筛选面板中添加排序选项
  - 时间排序（创建时间）
  - **置信度排序**（置信度评分，高到低或低到高）
  - 排序方向（升序/降序）
  - 默认：创建时间倒序（最新在前）
  - 排序选项：创建时间、置信度、更新时间

**状态**: ⏳ 待开始  
**预计时间**: 1天  
**依赖**: 4.1

### 4.4 实现组合筛选
- [ ] 确保筛选条件可以组合使用
  - 分类 + 标签 + 主题 + 时间范围 + 置信度范围
  - 筛选条件显示（已选标签、已选主题、已选置信度范围显示在顶部）
  - 筛选结果计数（共X条）
  - 显示筛选条件摘要

**状态**: ⏳ 待开始  
**预计时间**: 0.5天  
**依赖**: 4.2

### 4.5 实现筛选状态管理
- [ ] 使用 URL 参数管理筛选状态
  - 筛选条件同步到 URL query 参数
  - 支持浏览器前进/后退
  - 支持分享筛选后的链接
  - 或使用客户端状态管理（Zustand）

**状态**: ⏳ 待开始  
**预计时间**: 1天  
**依赖**: 4.2

### 4.6 集成到知识库页面
- [ ] 在 `src/app/knowledge/page.tsx` 中集成筛选面板
  - 左侧布局：筛选面板 + 列表
  - 响应式布局（移动端筛选面板折叠）
  - 筛选后刷新列表

**状态**: ⏳ 待开始  
**预计时间**: 0.5天  
**依赖**: 4.1, 4.5

---

## 阶段五：信息搜索功能

### 5.1 创建搜索组件
- [ ] 创建 `src/components/knowledge/search-box.tsx`
  - 使用 shadcn/ui Input 组件（带搜索图标）
  - 实时搜索（debounce）或按回车搜索
  - 搜索关键词高亮显示
  - 清空按钮

**状态**: ⏳ 待开始  
**预计时间**: 0.5天

### 5.2 实现全文搜索
- [ ] 在 API 路由中实现全文搜索
  - 更新 `src/app/api/knowledge/route.ts`
  - 使用 PostgreSQL 的 `ILIKE` 进行文本匹配
  - 搜索 content 字段
  - 未来可升级为 PostgreSQL 全文搜索（tsvector）

**状态**: ⏳ 待开始  
**预计时间**: 1天  
**依赖**: 5.1, 1.4

### 5.3 实现搜索结果高亮
- [ ] 在 `entry-card.tsx` 中实现关键词高亮
  - 创建高亮工具函数
  - 在内容摘要中高亮显示搜索关键词

**状态**: ⏳ 待开始  
**预计时间**: 0.5天  
**依赖**: 5.1, 3.2

### 5.4 实现搜索 + 筛选组合
- [ ] 确保搜索可以与筛选条件组合
  - 在筛选后的结果中搜索
  - 在搜索结果中应用筛选条件

**状态**: ⏳ 待开始  
**预计时间**: 0.5天  
**依赖**: 5.2, 4.2

### 5.5 集成到知识库页面
- [ ] 在页面顶部添加搜索框
  - 搜索框 + 筛选面板协同工作
  - 搜索状态同步到 URL 参数

**状态**: ⏳ 待开始  
**预计时间**: 0.5天  
**依赖**: 5.1, 4.6

---

## 阶段六：信息编辑与删除功能

### 6.1 实现编辑功能
- [ ] 复用 `entry-form.tsx` 组件（编辑模式）
  - 添加 `mode` 属性（create/edit）
  - 编辑模式下预填充数据
  - 更新 Server Action：`updateKnowledgeEntry()`
  - 编辑成功后刷新列表并更新 updated_at

**状态**: ⏳ 待开始  
**预计时间**: 1天  
**依赖**: 2.1, 1.4

### 6.2 实现删除功能
- [ ] 创建删除确认对话框
  - 使用 shadcn/ui AlertDialog 组件
  - 二次确认防误删
  - 显示要删除的条目信息（标题或摘要）
  - 删除 Server Action：`deleteKnowledgeEntry()`
  - 删除成功后刷新列表

**状态**: ⏳ 待开始  
**预计时间**: 0.5天  
**依赖**: 1.4

### 6.3 集成编辑和删除到卡片
- [ ] 在 `entry-card.tsx` 中添加操作按钮
  - 编辑按钮（打开编辑对话框）
  - 删除按钮（打开删除确认对话框）
  - 按钮位置：卡片右上角或底部操作区

**状态**: ⏳ 待开始  
**预计时间**: 0.5天  
**依赖**: 6.1, 6.2, 3.2

### 6.4 集成到详情页面（可选）
- [ ] 在 `entry-detail.tsx` 中添加编辑和删除按钮
  - 点击编辑跳转到编辑对话框
  - 点击删除显示确认对话框

**状态**: ⏳ 待开始  
**预计时间**: 0.5天  
**依赖**: 6.1, 6.2, 3.3

---

## 阶段七：主题管理功能（核心功能）

### 7.1 创建主题管理界面
- [ ] 创建 `src/app/knowledge/topics/page.tsx`（主题管理页面）
  - 主题列表展示（卡片式或列表式）
  - 显示主题名称、描述、颜色、图标、条目数量、创建时间
  - 操作按钮：编辑、删除、查看条目
- [ ] 创建 `src/components/knowledge/topic-list.tsx`
  - 主题列表组件
  - 支持搜索主题
  - 支持按条目数量排序
  - 显示空状态（无主题提示）

**状态**: ⏳ 待开始  
**预计时间**: 1.5天  
**依赖**: 1.4

### 7.2 创建主题卡片组件
- [ ] 创建 `src/components/knowledge/topic-card.tsx`
  - 使用 shadcn/ui Card 组件
  - 显示主题名称（带颜色和图标）
  - 显示主题描述
  - 显示条目数量
  - 显示创建时间
  - 操作按钮：编辑、删除、查看条目
  - 点击卡片跳转到主题视图

**状态**: ⏳ 待开始  
**预计时间**: 1天  
**依赖**: 7.1

### 7.3 实现主题创建和编辑
- [ ] 创建 `src/components/knowledge/topic-form.tsx`
  - 使用 shadcn/ui Dialog 组件
  - 表单字段：
    - 主题名称（必填，唯一验证）
    - 主题描述（可选）
    - 主题颜色（颜色选择器，可选）
    - 主题图标（图标选择器或emoji，可选）
  - 支持创建模式和编辑模式
  - 表单验证（名称必填、唯一性检查）
- [ ] 创建 Server Action：`createTopic()` 和 `updateTopic()`
  - 名称唯一性验证
  - 错误处理

**状态**: ⏳ 待开始  
**预计时间**: 2天  
**依赖**: 7.1, 1.4

### 7.4 实现主题删除
- [ ] 创建删除确认对话框
  - 使用 shadcn/ui AlertDialog 组件
  - 显示主题信息和条目数量
  - 警告：删除主题不会删除条目，只会移除关联
  - 二次确认防误删
- [ ] 创建 Server Action：`deleteTopic()`
  - 级联删除关联表中的记录
  - 不影响条目本身

**状态**: ⏳ 待开始  
**预计时间**: 0.5天  
**依赖**: 7.1, 1.4

### 7.5 实现主题视图
- [ ] 创建 `src/app/knowledge/topics/[id]/page.tsx`（主题详情页）
  - 显示主题信息（名称、描述、颜色、图标）
  - 显示该主题下的所有条目列表
  - 使用 `entry-list.tsx` 组件展示条目
  - 支持在该主题下筛选和搜索
- [ ] 集成主题视图到知识库页面
  - 点击主题标签跳转到主题视图
  - 或显示主题筛选后的结果

**状态**: ⏳ 待开始  
**预计时间**: 1.5天  
**依赖**: 7.1, 3.1, 4.6

### 7.6 实现批量添加到主题
- [ ] 在知识库列表中添加批量操作功能
  - 多选条目（复选框）
  - 批量添加到主题按钮
  - 选择主题对话框（显示已有主题列表）
  - 支持创建新主题并添加
- [ ] 创建 Server Action：`addEntriesToTopic()`
  - 批量添加条目到主题
  - 跳过已存在的关联（唯一约束）

**状态**: ⏳ 待开始  
**预计时间**: 1.5天  
**依赖**: 7.1, 3.1, 1.4

### 7.7 实现从标签创建主题（可选）
- [ ] 创建 `src/components/knowledge/create-topic-from-labels.tsx`
  - 分析现有标签的使用频率
  - 建议创建主题（基于常用标签）
  - 一键创建主题并添加相关条目
  - 显示预览（哪些条目会被添加）
- [ ] 创建 Server Action：`createTopicFromLabels()`
  - 基于标签创建主题
  - 自动关联包含该标签的条目

**状态**: ⏳ 待开始  
**预计时间**: 2天  
**依赖**: 7.1, 1.4

### 7.8 集成主题管理到知识库页面
- [ ] 在知识库页面添加主题管理入口
  - 主题列表侧边栏或顶部选项卡
  - 快速切换主题视图
  - 主题筛选集成到筛选面板

**状态**: ⏳ 待开始  
**预计时间**: 1天  
**依赖**: 7.1, 4.6

---

## 阶段八：LLM分析上下文快速选择（核心功能）

### 8.1 创建分析上下文选择组件
- [ ] 创建 `src/components/analysis/context-selector.tsx`
  - 显示可用的主题列表（卡片式）
  - 每个主题卡片显示：名称、描述、条目数量
  - 支持选择主题（单选或多选）
  - 支持选择主题后预览条目列表
- [ ] 集成到分析页面
  - 左侧或顶部显示主题选择区域
  - 选择主题后自动加载该主题下的所有条目

**状态**: ⏳ 待开始  
**预计时间**: 2天  
**依赖**: 7.1, 1.4

### 8.2 实现主题快速加载到上下文
- [ ] 在分析页面实现主题选择功能
  - 点击主题卡片后，自动将该主题下的所有条目添加到分析上下文
  - 显示已选择的主题和条目数量
  - 支持移除已选择的主题
  - 支持多选主题（组合多个主题的条目）
- [ ] 更新分析API
  - 支持通过 `topicIds` 参数快速加载主题下的条目
  - 返回该主题下的所有条目ID列表

**状态**: ⏳ 待开始  
**预计时间**: 1.5天  
**依赖**: 8.1, 1.2

### 8.3 实现上下文预览和编辑
- [ ] 在分析页面显示已选择的条目预览
  - 显示已选择条目的摘要列表
  - 支持移除单个条目
  - 支持手动添加其他条目（通过筛选或搜索）
- [ ] 实现上下文编辑功能
  - 在上下文预览中支持编辑条目列表
  - 支持从主题添加、从筛选添加、从搜索添加

**状态**: ⏳ 待开始  
**预计时间**: 1.5天  
**依赖**: 8.2

### 8.4 优化分析页面布局
- [ ] 优化分析页面布局，支持主题选择
  - 左侧：主题选择 + 条目筛选
  - 中间：上下文预览 + Agent选择
  - 右侧：问题输入 + 结果对比
  - 或顶部：主题选择栏，中间：上下文和问题，下方：结果

**状态**: ⏳ 待开始  
**预计时间**: 1天  
**依赖**: 8.1

---

## 阶段九：数据导出功能

### 9.1 实现 JSON 导出
- [ ] 在 `src/app/api/knowledge/export/route.ts` 中实现 JSON 导出
  - 支持全量导出
  - 支持按筛选条件导出
  - 导出数据格式：完整的条目信息（包括所有字段）
  - 设置响应头：`Content-Type: application/json`
  - 文件名：`knowledge-export-YYYY-MM-DD.json`

**状态**: ⏳ 待开始  
**预计时间**: 1天  
**依赖**: 1.4, 4.2

### 9.2 实现 CSV 导出
- [ ] 在导出 API 中添加 CSV 格式支持
  - 解析 JSON 数据转换为 CSV
  - 处理特殊字符（逗号、引号、换行）
  - 设置响应头：`Content-Type: text/csv`
  - 文件名：`knowledge-export-YYYY-MM-DD.csv`

**状态**: ⏳ 待开始  
**预计时间**: 1天  
**依赖**: 9.1

### 9.3 创建导出按钮组件
- [ ] 创建 `src/components/knowledge/export-button.tsx`
  - 导出按钮（下拉菜单：JSON/CSV）
  - 导出当前筛选后的数据
  - 导出进度提示（可选）
  - 错误处理

**状态**: ⏳ 待开始  
**预计时间**: 0.5天  
**依赖**: 9.1, 9.2

### 9.4 集成到知识库页面
- [ ] 在页面顶部工具栏添加导出按钮
  - 显示在"新建信息"按钮旁边
  - 导出时使用当前筛选条件

**状态**: ⏳ 待开始  
**预计时间**: 0.5天  
**依赖**: 9.3, 4.6

---

## 阶段十：性能优化与用户体验增强

### 10.1 实现虚拟滚动（可选）
- [ ] 对于大量数据，使用虚拟滚动
  - 使用 `react-virtual` 或 `@tanstack/react-virtual`
  - 提升列表渲染性能

**状态**: ⏳ 待开始  
**预计时间**: 1天  
**依赖**: 3.1

### 10.2 添加加载状态
- [ ] 在列表加载时显示 Skeleton
  - 使用 shadcn/ui Skeleton 组件
  - 卡片骨架屏
  - 筛选/搜索时显示加载状态

**状态**: ⏳ 待开始  
**预计时间**: 0.5天  
**依赖**: 3.1

### 10.3 添加空状态
- [ ] 创建空状态组件
  - 无数据提示
  - 无搜索结果提示
  - 无筛选结果提示
  - 引导用户创建第一条记录

**状态**: ⏳ 待开始  
**预计时间**: 0.5天  
**依赖**: 3.1

### 10.4 优化标签显示
- [ ] 标签数量限制和展开
  - 列表显示前3个标签，更多标签显示"+X"
  - 详情页显示所有标签
  - 标签颜色区分（可选）

**状态**: ⏳ 待开始  
**预计时间**: 0.5天  
**依赖**: 3.2

### 10.5 添加快捷操作
- [ ] 键盘快捷键支持（可选）
  - `Cmd/Ctrl + N` - 新建信息
  - `Cmd/Ctrl + F` - 聚焦搜索框
  - `Esc` - 关闭对话框

**状态**: ⏳ 待开始  
**预计时间**: 0.5天

### 10.6 响应式设计优化
- [ ] 确保移动端体验良好
  - 筛选面板在小屏幕上折叠
  - 卡片布局自适应
  - 触摸操作友好

**状态**: ⏳ 待开始  
**预计时间**: 1天  
**依赖**: 4.6

---

## 阶段十一：测试与文档（可选）

### 11.1 单元测试（可选）
- [ ] 为工具函数编写测试
  - `src/lib/knowledge.ts` 中的函数
  - 标签处理函数

**状态**: ⏳ 待开始  
**预计时间**: 1-2天

### 11.2 集成测试（可选）
- [ ] 为 API 路由编写测试
  - 创建、查询、更新、删除
  - 筛选和搜索功能

**状态**: ⏳ 待开始  
**预计时间**: 1-2天

### 11.3 用户文档（可选）
- [ ] 编写用户使用文档
  - 功能介绍
  - 操作指南
  - 常见问题

**状态**: ⏳ 待开始  
**预计时间**: 0.5天

---

## 总体进度跟踪

### 完成度统计
- **阶段一**：基础数据结构与API - 0/6 完成（新增：主题迁移、主题API）
- **阶段二**：信息录入功能 - 0/5 完成
- **阶段三**：信息展示功能 - 0/6 完成
- **阶段四**：信息筛选功能 - 0/6 完成
- **阶段五**：信息搜索功能 - 0/5 完成
- **阶段六**：信息编辑与删除功能 - 0/4 完成
- **阶段七**：主题管理功能 - 0/8 完成（新增阶段）
- **阶段八**：LLM分析上下文快速选择 - 0/4 完成（新增阶段）
- **阶段九**：数据导出功能 - 0/4 完成
- **阶段十**：性能优化与用户体验增强 - 0/6 完成
- **阶段十一**：测试与文档 - 0/3 完成

**总计**: 0/61 任务完成（新增17个任务：主题功能8个 + LLM分析集成4个 + 其他5个）

### 预计总时间
- 核心功能（阶段一至六）：约 18-22 天
- 完整功能（阶段一至十，包含主题和LLM集成）：约 28-35 天
- 包含测试文档（阶段一至十一）：约 30-38 天

---

## 注意事项

1. **优先级**：阶段一至六是核心功能，必须完成。阶段七至九为增强功能，可根据时间安排决定是否完成。
2. **依赖关系**：严格按照阶段顺序开发，确保依赖的功能已完成。
3. **技术选型**：使用已确定的技术栈（Next.js 14+, Supabase, shadcn/ui, TypeScript）。
4. **数据模型**：所有功能需基于 `knowledge_entries` 表，不要随意修改表结构。
5. **用户体验**：保持界面简洁，操作不超过3次点击。
6. **性能要求**：知识库过滤和检索在万条记录内实现毫秒级响应。

---

## 更新日志

- **2024-11-01**: 创建初始任务清单，完成知识库模块功能分析和任务规划
- **2024-11-01**: 添加置信度评分功能
  - 创建数据库迁移文件 `20240102000000_add_confidence_score.sql`
  - 更新子模块划分，添加置信度相关功能
  - 更新阶段一：添加置信度字段验证和迁移任务
  - 更新阶段二：录入表单添加置信度评分输入
  - 更新阶段三：展示组件添加置信度显示
  - 更新阶段四：筛选和排序功能支持置信度
  - 更新类型定义，包含置信度相关类型
- **2024-11-01**: 添加主题管理功能
  - 创建数据库迁移文件 `20240103000000_add_topics.sql`
  - 创建 topics 表和 knowledge_entry_topics 关联表
  - 新增阶段七：主题管理功能（8个任务）
    - 主题创建、编辑、删除
    - 主题视图和列表
    - 批量添加到主题
    - 从标签创建主题建议
  - 新增阶段八：LLM分析上下文快速选择（4个任务）
    - 主题快速加载到分析上下文
    - 上下文预览和编辑
    - 分析页面布局优化
  - 更新阶段一：添加主题API路由和工具函数
  - 更新阶段二：录入表单添加主题选择
  - 更新阶段三：展示组件添加主题显示
  - 更新阶段四：筛选功能添加主题筛选
  - 更新类型定义，包含主题相关类型

